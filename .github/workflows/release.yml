name: Release

on:
  release:
    types: [published, created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release'
        required: true
        default: 'patch'

jobs:
  test-release:
    name: Test Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run tests
      run: pytest tests/ -v
    
    - name: Build package
      run: |
        python -m pip install --upgrade build
        python -m build
    
    - name: Test package installation
      run: |
        pip install dist/*.whl
        err_x509 --version
        err_x509 --help
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-build
        path: dist/
        retention-days: 1

  build-executables:
    name: Build Executables (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            output_name: err_x509.exe
            output_suffix: windows
            pyinstaller_opts: "--onefile --name err_x509 --add-data 'err_x509:err_x509' --hidden-import=click --hidden-import=yaml --hidden-import=err_x509 --hidden-import=err_x509.core --hidden-import=err_x509.utils --hidden-import=err_x509.config --clean --noconfirm"
          - os: ubuntu-latest
            output_name: err_x509
            output_suffix: linux
            pyinstaller_opts: "--onefile --name err_x509 --add-data 'err_x509:err_x509' --hidden-import=click --hidden-import=yaml --hidden-import=err_x509 --hidden-import=err_x509.core --hidden-import=err_x509.utils --hidden-import=err_x509.config --clean --noconfirm"
          - os: macos-latest
            output_name: err_x509
            output_suffix: macos
            pyinstaller_opts: "--onefile --name err_x509 --add-data 'err_x509:err_x509' --hidden-import=click --hidden-import=yaml --hidden-import=err_x509 --hidden-import=err_x509.core --hidden-import=err_x509.utils --hidden-import=err_x509.config --clean --noconfirm"
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pyinstaller
    
    - name: Install UPX for compression (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
          sudo apt-get update && sudo apt-get install -y upx
        elif [ "${{ matrix.os }}" == "macos-latest" ]; then
          brew install upx || true
        fi
    
    - name: Create spec file for better control
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸ÑŽ Ð´Ð»Ñ PyInstaller
        cat > build_spec.py << 'EOF'
        import PyInstaller.__main__
        import os
        import sys
        
        # Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¾Ð¿Ñ†Ð¸Ð¸
        opts = [
            'err_x509/cli.py',
            '--onefile',
            '--name=err_x509',
            '--clean',
            '--noconfirm',
        ]
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ
        opts.extend(['--add-data', 'err_x509' + os.pathsep + 'err_x509'])
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹
        hidden_imports = [
            'click',
            'yaml',
            'err_x509',
            'err_x509.core',
            'err_x509.utils',
            'err_x509.config',
        ]
        
        for imp in hidden_imports:
            opts.extend(['--hidden-import', imp])
        
        # Ð”Ð»Ñ Windows Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸ÐºÐ¾Ð½ÐºÑƒ, ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
        if sys.platform == 'win32':
            if os.path.exists('scripts/icon.ico'):
                opts.extend(['--icon', 'scripts/icon.ico'])
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ PyInstaller
        PyInstaller.__main__.run(opts)
        EOF
        
        python build_spec.py
    
    - name: Build with PyInstaller
      run: |
        echo "Building executable for ${{ matrix.os }} with options: ${{ matrix.pyinstaller_opts }}"
        
        # Ð Ð°Ð·Ð±Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÑƒ Ð¾Ð¿Ñ†Ð¸Ð¹ Ð½Ð° Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹
        IFS=' ' read -r -a OPTS_ARRAY <<< "${{ matrix.pyinstaller_opts }}"
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ PyInstaller
        pyinstaller "${OPTS_ARRAY[@]}" err_x509/cli.py
        
        echo "âœ… Build completed!"
    
    - name: Test the built executable
      run: |
        echo "Testing the executable..."
        
        cd dist
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³
        cat > test_config.yaml << 'EOF'
        port: 7890
        proxies:
          - {name: test1, server: s1.example.com, port: 443}
          - {name: test2, server: s2.example.com, port: 443}
        EOF
        
        # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ ÐžÐ¡
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          ./err_x509.exe --version
          ./err_x509.exe preview test_config.yaml
        else
          chmod +x ./err_x509
          ./err_x509 --version
          ./err_x509 preview test_config.yaml
        fi
        
        echo "âœ… Executable test passed!"
    
    - name: Rename output with version
      run: |
        cd dist
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· pyproject.toml
        VERSION=$(grep -m1 'version =' ../pyproject.toml | cut -d'"' -f2)
        echo "Version: $VERSION"
        
        # ÐŸÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          NEW_NAME="err_x509_v${VERSION}_${{ matrix.output_suffix }}.exe"
          mv err_x509.exe "$NEW_NAME"
          echo "Renamed to: $NEW_NAME"
        else
          NEW_NAME="err_x509_v${VERSION}_${{ matrix.output_suffix }}"
          mv err_x509 "$NEW_NAME"
          echo "Renamed to: $NEW_NAME"
        fi
        
        # Ð”ÐµÐ»Ð°ÐµÐ¼ Unix Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼Ð¸
        if [ "${{ matrix.os }}" != "windows-latest" ]; then
          chmod +x "$NEW_NAME"
        fi
    
    - name: Upload executable artifact
      uses: actions/upload-artifact@v4
      with:
        name: executable-${{ matrix.output_suffix }}
        path: dist/err_x509_v*_${{ matrix.output_suffix }}*
        retention-days: 30

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [test-release, build-executables]
    environment: pypi
    permissions:
      id-token: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: Extract version from tag
      if: github.event_name == 'release'
      id: get_version
      run: |
        VERSION="${GITHUB_REF#refs/tags/v}"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "VERSION=${VERSION}" >> $GITHUB_ENV
    
    - name: Update version in pyproject.toml
      if: github.event_name == 'release'
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        sed -i "s/^version = \".*\"/version = \"$VERSION\"/" pyproject.toml
        echo "Updated version to $VERSION"
    
    - name: Build package
      run: |
        python -m build
    
    - name: Verify package
      run: |
        twine check dist/*
    
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1.10
    
    - name: Upload PyPI artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pypi-release
        path: |
          dist/*.tar.gz
          dist/*.whl
        retention-days: 30

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [publish-pypi, build-executables]
    if: github.event_name == 'release'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Prepare release assets
      run: |
        echo "Preparing release assets..."
        
        VERSION="${GITHUB_REF#refs/tags/v}"
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð°
        mkdir -p release_assets
        
        # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¸ ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
        find artifacts/ -type f \( -name "*.exe" -o -name "err_x509_v*" \) -exec cp {} release_assets/ \;
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ PyPI Ð¿Ð°ÐºÐµÑ‚Ñ‹
        find artifacts/ -name "*.tar.gz" -type f -exec cp {} release_assets/ \;
        find artifacts/ -name "*.whl" -type f -exec cp {} release_assets/ \;
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ ÑÑƒÐ¼Ð¼Ð°Ð¼Ð¸
        cd release_assets
        sha256sum * > checksums.txt
        
        echo "Release assets prepared:"
        ls -la
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: release_assets/*
        generate_release_notes: true
        draft: false
        prerelease: false

  build-portable:
    name: Build Portable Packages
    runs-on: ubuntu-latest
    needs: build-executables
    if: github.event_name == 'release'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download executable artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Create portable packages
      run: |
        echo "Creating portable packages..."
        
        VERSION="${GITHUB_REF#refs/tags/v}"
        
        # Ð”Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð²
        for platform in windows linux macos; do
          echo "Processing $platform..."
          
          EXE_PATH=""
          
          # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹
          if [ "$platform" = "windows" ]; then
            EXE_PATH=$(find artifacts/ -name "*_windows.exe" -type f | head -1)
            if [ -z "$EXE_PATH" ]; then
              echo "âš ï¸  No Windows executable found, skipping..."
              continue
            fi
          elif [ "$platform" = "linux" ]; then
            EXE_PATH=$(find artifacts/ -name "*_linux" -type f ! -name "*.exe" | head -1)
          elif [ "$platform" = "macos" ]; then
            EXE_PATH=$(find artifacts/ -name "*_macos" -type f ! -name "*.exe" | head -1)
          fi
          
          if [ -z "$EXE_PATH" ]; then
            echo "âš ï¸  No executable found for $platform, skipping..."
            continue
          fi
          
          echo "Found executable: $EXE_PATH"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¿Ð°Ð¿ÐºÑƒ
          TEMP_DIR="temp_${platform}"
          mkdir -p "$TEMP_DIR"
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
          cp "$EXE_PATH" "$TEMP_DIR/"
          
          # ÐŸÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ð² ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð¾Ðµ Ð¸Ð¼Ñ
          cd "$TEMP_DIR"
          if [ "$platform" = "windows" ]; then
            mv *.exe err_x509.exe
          else
            mv * err_x509
            chmod +x err_x509
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ README
          cat > README.txt << EOF
          ========================================
          err_x509 Portable v${VERSION} (${platform^})
          ========================================
          
          No installation required! Just extract and run.
          
          Usage:
          1. Extract this ZIP to any folder
          2. Open terminal in that folder
          3. Run: $(if [ "$platform" = "windows" ]; then echo "err_x509.exe"; else echo "./err_x509"; fi) fix config.yaml
          
          Examples:
          - Fix config: $(if [ "$platform" = "windows" ]; then echo "err_x509.exe"; else echo "./err_x509"; fi) fix config.yaml
          - Batch process: $(if [ "$platform" = "windows" ]; then echo "err_x509.exe"; else echo "./err_x509"; fi) batch ./folder/
          - Get help: $(if [ "$platform" = "windows" ]; then echo "err_x509.exe --help"; else echo "./err_x509 --help"; fi)
          
          GitHub: https://github.com/13winged/err_x509
          EOF
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð°
          cat > example.yaml << 'EOF'
          port: 7890
          proxies:
            - name: Test Server
              server: example.com
              port: 443
          EOF
          
          # Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ÑÑ Ð½Ð°Ð·Ð°Ð´
          cd ..
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ZIP Ð°Ñ€Ñ…Ð¸Ð²
          ZIP_NAME="err_x509_v${VERSION}_${platform}_portable.zip"
          zip -r "$ZIP_NAME" "$TEMP_DIR/"
          
          echo "âœ… Created: $ZIP_NAME"
          
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¿Ð°Ð¿ÐºÑƒ
          rm -rf "$TEMP_DIR"
        done
    
    - name: Upload portable packages
      uses: actions/upload-artifact@v4
      with:
        name: portable-packages
        path: "*.zip"
        retention-days: 30

  announce:
    name: Announce Release
    runs-on: ubuntu-latest
    needs: [create-release, build-portable]
    if: github.event_name == 'release'
    
    steps:
    - name: Generate release notes
      run: |
        VERSION="${GITHUB_REF#refs/tags/v}"
        echo "RELEASE_VERSION=${VERSION}" >> $GITHUB_ENV
    
    - name: Send Discord notification
      if: success()
      uses: sarisia/actions-status-discord@v1
      env:
        webhook: ${{ secrets.DISCORD_WEBHOOK }}
      with:
        title: "ðŸš€ err_x509 v${VERSION} Released!"
        description: |
          Now with standalone executables for Windows, Linux, and macOS!
          
          **Download:** https://github.com/13winged/err_x509/releases/tag/v${VERSION}
          
          No Python required! Just download and run.
        color: 0x00FF00
        url: "https://github.com/13winged/err_x509/releases/tag/v${VERSION}"

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Clean up workspace
      run: |
        echo "Cleaning up workspace..."
        rm -rf dist/ build/ *.egg-info/ artifacts/ release_assets/ temp_*/