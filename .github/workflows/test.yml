name: Tests

on:
  push:
    branches: [ main, develop, feature/* ]
    paths:
      - 'err_x509/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'err_x509/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'requirements*.txt'

jobs:
  test:
    name: "Test Python ${{ matrix.python-version }} on ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.7', '3.8', '3.9', '3.10', '3.11', '3.12']
        exclude:
          - os: windows-latest
            python-version: '3.7'  # Python 3.7 not available on Windows
          - os: macos-latest
            python-version: '3.7'  # Python 3.7 not available on macOS
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Display Python version
      run: python -c "import sys; print(f'Python {sys.version}')"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip list
    
    - name: Check code formatting with black
      run: |
        black --check --diff err_x509/ tests/
    
    - name: Lint with flake8
      run: |
        flake8 err_x509/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 err_x509/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics
    
    - name: Check import sorting with isort
      run: |
        isort --check-only --diff err_x509/ tests/
    
    - name: Type checking with mypy
      run: |
        mypy err_x509/ --ignore-missing-imports
    
    - name: Run unit tests with pytest
      run: |
        pytest tests/ -v --cov=err_x509 --cov-report=xml --cov-report=term-missing
    
    - name: Run CLI tests
      run: |
        python -m pytest tests/test_cli.py -v
    
    - name: Test package installation
      run: |
        python -m pip install --upgrade build
        python -m build
        pip install dist/*.whl
        err_x509 --version
        err_x509 --help
    
    - name: Test examples
      run: |
        # Create test configuration
        cat > test_config.yaml << 'EOF'
        port: 7890
        proxies:
          - {name: test1, server: s1.example.com, port: 443}
          - {name: test2, server: s2.example.com, port: 443}
        EOF
        
        # Test basic functionality
        err_x509 fix test_config.yaml
        err_x509 fix -v -b test_config.yaml
        err_x509 preview test_config.yaml
        err_x509 check
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
        path: |
          test-results/
          coverage.xml
        retention-days: 7

  lint:
    name: Lint and Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 isort mypy bandit safety
    
    - name: Run Black formatting check
      run: black --check err_x509/ tests/
    
    - name: Run Flake8
      run: flake8 err_x509/ tests/ --max-line-length=88
    
    - name: Run isort
      run: isort --check-only err_x509/ tests/
    
    - name: Run Bandit security scan
      run: bandit -r err_x509/ -c pyproject.toml
    
    - name: Run safety check
      run: safety check
    
    - name: Check for large files
      run: |
        # Check for files larger than 1MB
        find . -type f -size +1M ! -path "./.git/*" ! -path "./venv/*" ! -path "./dist/*" ! -path "./build/*" | head -10

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install package
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Create test scenarios
      run: |
        mkdir -p test_integration
        cd test_integration
        
        # Create various test configurations
        cat > single_line.yaml << 'EOF'
        port: 7890 proxies: - {name: test1, server: s1.com} - {name: test2, server: s2.com}
        EOF
        
        cat > multi_line.yaml << 'EOF'
        port: 7890
        proxies:
          - name: test1
            server: s1.com
            port: 443
          - name: test2
            server: s2.com
            port: 443
        EOF
        
        cat > with_ssl.yaml << 'EOF'
        port: 7890
        proxies:
          - {name: test1, server: s1.com, skip-cert-verify: false}
          - {name: test2, server: s2.com, skip-cert-verify: true}
        EOF
        
        cat > no_proxies.yaml << 'EOF'
        port: 7890
        mode: global
        EOF
        
        # Create directory for batch test
        mkdir batch_test
        cp *.yaml batch_test/
    
    - name: Run integration tests
      run: |
        cd test_integration
        
        echo "=== Testing single-line format ==="
        err_x509 fix single_line.yaml
        echo "✅ Single-line test passed"
        
        echo "=== Testing multi-line format ==="
        err_x509 fix -v multi_line.yaml
        echo "✅ Multi-line test passed"
        
        echo "=== Testing with existing SSL settings ==="
        err_x509 fix with_ssl.yaml
        echo "✅ Existing SSL test passed"
        
        echo "=== Testing no proxies case ==="
        err_x509 fix no_proxies.yaml
        echo "✅ No proxies test passed"
        
        echo "=== Testing batch processing ==="
        err_x509 batch batch_test/
        echo "✅ Batch test passed"
        
        echo "=== Testing dry-run ==="
        err_x509 fix --dry-run single_line.yaml
        echo "✅ Dry-run test passed"
        
        echo "=== Testing preview ==="
        err_x509 preview single_line.yaml
        echo "✅ Preview test passed"
        
        echo "=== Testing check command ==="
        err_x509 check
        echo "✅ Check command test passed"
    
    - name: Verify outputs
      run: |
        cd test_integration
        
        # Check that output files exist
        ls -la *.fixed.yaml
        
        # Verify SSL fix was applied
        for file in *.fixed.yaml; do
          if grep -q "skip-cert-verify: true" "$file"; then
            echo "✅ SSL fix found in $file"
          else
            echo "❌ SSL fix NOT found in $file"
            exit 1
          fi
        done

  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Check documentation
      run: |
        # Check that documentation files exist
        test -f README.md && echo "✅ README.md exists"
        test -f README_RU.md && echo "✅ README_RU.md exists"
        test -f docs/usage.md && echo "✅ docs/usage.md exists"
        test -f docs/api.md && echo "✅ docs/api.md exists"
        test -f docs/advanced.md && echo "✅ docs/advanced.md exists"
        
        # Check for broken links in README
        echo "Checking for broken links..."
        grep -o 'https://[^)]*' README.md | head -10
        
        # Check that examples are valid
        echo "Checking example commands..."
        grep -E '^```bash|^```python' README.md | wc -l
    
    - name: Build documentation
      run: |
        python -m pip install sphinx sphinx-rtd-theme myst-parser
        mkdir -p docs/_build
        echo "Documentation build would go here"

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test, lint, integration, docs]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "# Test Summary" > summary.md
        echo "" >> summary.md
        echo "## Jobs Status" >> summary.md
        echo "" >> summary.md
        echo "- Tests: ${{ needs.test.result }}" >> summary.md
        echo "- Lint: ${{ needs.lint.result }}" >> summary.md
        echo "- Integration: ${{ needs.integration.result }}" >> summary.md
        echo "- Docs: ${{ needs.docs.result }}" >> summary.md
        echo "" >> summary.md
        echo "All checks completed at $(date)" >> summary.md
    
    - name: Upload summary
      uses: actions/upload-artifact@v4
      with:
        name: test-summary
        path: summary.md